###############################################################################
# BRLTTY - A background process providing access to the console screen (when in
#          text mode) for a blind person using a refreshable braille display.
#
# Copyright (C) 1995-2009 by The BRLTTY Developers.
#
# BRLTTY comes with ABSOLUTELY NO WARRANTY.
#
# This is free software, placed under the terms of the
# GNU General Public License, as published by the Free Software
# Foundation; either version 2 of the License, or (at your option) any
# later version. Please see the file LICENSE-GPL for details.
#
# Web Page: http://mielke.cc/brltty/
#
# This software is maintained by Dave Mielke <dave@mielke.cc>.
###############################################################################

DRIVER_CODE = pm
DRIVER_NAME = Papenmeier
DRIVER_COMMENT = Compact 486, Compact/Tiny, IB 80 CR Soft, 2D Lite (plus), 2D Screen Soft, EL 80, EL 2D 40/66/80, EL 40/66/70/80 S, EL 2D 80 S, EL 40 P, EL 80 II, Elba 20/32, Trio 40/Elba20/Elba32
DRIVER_VERSION = 
DRIVER_DEVELOPERS = August Hörandl <august.hoerandl@gmx.at>, Heimo Schön <heimo.schoen@gmx.at>
HELP_DEPS = $(HELP_TEXT)
include $(SRC_TOP)braille.mk

PM_CMD_SOURCES = $(SRC_TOP)$(PGM_DIR)/brldefs.h $(SRC_DIR)/brl-cfg.h

braille.$O:
	$(CC) $(BRL_CFLAGS) $(YACC_CFLAGS) -c $(SRC_DIR)/braille.c

READ_CONFIG_OBJECTS = read_config.$O $(BLD_TOP)$(PGM_DIR)/host_cmd.$O $(BLD_TOP)$(PGM_DIR)/host_ttb_translate.$O $(BLD_TOP)$(PGM_DIR)/host_charset.$O $(BLD_TOP)$(PGM_DIR)/host_lock.$O $(BLD_TOP)$(PGM_DIR)/host_misc.$O $(BLD_TOP)$(PGM_DIR)/host_io_misc.$O $(BLD_TOP)$(PGM_DIR)/host_queue.$O $(BLD_TOP)$(PGM_DIR)/host_async.$O $(BLD_TOP)$(PGM_DIR)/host_keycodes.$O $(BLD_TOP)$(PGM_DIR)/host_keyboard.$O $(BLD_TOP)$(PGM_DIR)/host_$(SYSTEM_OBJECT)
read_config$X: $(READ_CONFIG_OBJECTS)
	$(HOSTCC) $(HOSTLDFLAGS) -o $@ $(READ_CONFIG_OBJECTS) $(LDLIBS)

read_config.$O:
	$(HOSTCC) $(HOSTCFLAGS) $(YACC_CFLAGS) -c $(SRC_DIR)/read_config.c

$(BLD_TOP)$(PGM_DIR)/%.$O:
	cd $(@D) && $(MAKE) $(@F)

config.tab.c:
	$(YACC) -b config -v $(SRC_DIR)/config.y

cmd.auto.h: $(PM_CMD_SOURCES) $(SRC_DIR)/cmd.awk
	$(AWK) -f $(SRC_DIR)/cmd.awk $(PM_CMD_SOURCES) >$@

hlp.auto.h: $(PM_CMD_SOURCES) $(SRC_DIR)/hlp.awk
	$(AWK) -f $(SRC_DIR)/hlp.awk $(PM_CMD_SOURCES) >$@

###############################################################################

braille-help:: help-files

PM_HELP_FILES = brltty-pm-*.hlp

help-files: $(BLD_TOP)$(DAT_DIR)/$(PM_HELP_FILES)

$(BLD_TOP)$(DAT_DIR)/$(PM_HELP_FILES): $(PM_HELP_FILES) $(TXT2HLP)
	for file in brltty-$(DRIVER_CODE)-*.hlp; do $(TXT2HLP) $(BLD_TOP)$(DAT_DIR)/$$file $$file; done

$(PM_HELP_FILES): read_config$X
	./read_config$X h

###############################################################################

braille-help:: @PM_CONFIGFILE_DEPENDENCY@

PM_CONFIG_FILE = brltty-$(DRIVER_CODE).conf

configuration-file: $(BLD_TOP)$(DAT_DIR)/$(PM_CONFIG_FILE)

$(BLD_TOP)$(DAT_DIR)/$(PM_CONFIG_FILE): $(PM_CONFIG_FILE)
	cp $(PM_CONFIG_FILE) $(BLD_TOP)$(DAT_DIR)/

$(PM_CONFIG_FILE): read_config$X
	./read_config$X d >$@

###############################################################################

clean::
	-rm -f read_config$X config.tab.c config.output
	-rm -f brltty-$(DRIVER_CODE)-*.hlp $(PM_CONFIG_FILE)

distclean::
	-rm -f *.good *.diff *.out

###############################################################################

TEST_CASES = test.1.in test.2.in

TEST_RESULT = $(TEST_CASES:.in=.out)
TEST_OK = $(TEST_CASES:.in=.good)
TEST_DIFF = $(TEST_CASES:.in=.diff)

dump: read_config$X
	read_config$X d

good: $(TEST_OK)
%.good: %.in read_config$X
	./read_config$X d $< <$< >$@

diff: $(TEST_DIFF)
%.diff: %.in good
	-diff -b $< $*.good >$@

out: $(TEST_RESULT)
%.out: %.in good read_config$X
	./read_config$X d $< <$< | ./read_config$X d $< | diff -b $*.good - >$@
